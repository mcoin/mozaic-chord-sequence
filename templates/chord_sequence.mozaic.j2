{# Mozaic Chord Sequence Script Template #}
{# This template generates a complete Mozaic script for chord sequence playback #}

@OnLoad
  Log {Chord Sequence}
  SetShortName {Chordsequence}
  ShowLayout 2
  prevPad =0
  SongNb = 0
  SetKnobValue 0, 0
  LabelKnob 0, {Bar -}
  SetKnobValue 1, SongNb
  LastKnob = 1
  Call @OnKnobChange
  Call @InitializeSong
  LabelKnob 2, {-}
  LabelKnob 3, {-}
  LabelKnobs {Chord Sequence}
  // Tap tempo settings
  TapChannel = 16
  TapNote = 90
  // Fill trigger settings
  FillChannel = 10
  FillControl = 48
  FillValue = 127
  FillDelay = -100
  // Rhythm selection settings
  RhythmSetChannel = 10
  RhythmBankCC = 31
  RhythmCC = 32
  RhythmSetDelay = 1000
  // Chord note playback settings
  ChordNoteChannel = 11
  SimplifiedChordChannel = 12
  ChordNoteVelocity = 64
  PrevBar = -1
  PrevBeat = -1
  // Array to store currently playing notes for note-off
  for i = 0 to 9
    ActiveNotes[i] = -1
    ActiveSimplifiedNotes[i] = -1
  endfor
  NumActiveNotes = 0
  NumActiveSimplifiedNotes = 0
  // Range for stopping all notes (C2 to C5)
  StopAllNotesMin = 36
  StopAllNotesMax = 72
@End

@StartTempoChange
	minuteMs = 60000
	quarterInterval = minuteMs / NewTempo
	Log quarterInterval
	SetTimerInterval quarterInterval
	repeats = 0
	StartTimer
@End

@OnTimer
	repeats = repeats + 1
	Log repeats
	SendMIDINoteOn TapChannel - 1, TapNote, 127
	SendMIDINoteOff TapChannel - 1, TapNote, 127
	if repeats = 5
		StopTimer
		repeats = 0
	endif
@End

@OnHostStart
  // Stop all notes when host starts playback
  Call @StopAllNotes
@End

@OnHostStop
  // Stop all notes when host stops playback
  Call @StopAllNotes
@End

@OnShiftDown
  // Stop all notes when shift key is pressed
  Call @StopAllNotes
@End

@OnPadDown
  Log {Pad }, LastPad
  if LastPad = 7
    Dec SongNb, 0
    SetKnobValue 1, SongNb
    LastKnob = 1
    Call @OnKnobChange
    Call @ClearPads
  elseif LastPad = 15
    Inc SongNb, 127
    SetKnobValue 1, SongNb
    LastKnob = 1
    Call @OnKnobChange
    Call @ClearPads
  elseif LastPad = 0
    Call @SetSongRhythm
  endif
@End

@OnKnobChange
  Log {Changed knob }, LastKnob
  Log (GetKnobValue LastKnob)

  if LastKnob = 1
    SongNb = RoundDown GetKnobValue LastKnob
    LabelKnob 1, {Song }, SongNb
    Call @InitializeSong
  endif
@End

{# Initialize Song Block - dynamically generated from songs list #}
@InitializeSong
{% for song in songs %}
  {{ 'if' if loop.first else 'elseif' }} SongNb = {{ loop.index0 }}
    LabelPads { {{- song.title -}} }
    NbOfBars = {{ song.num_bars }}
{% endfor %}
  else
    LabelPads {Unassigned}
  endif
@End

{# Tempo/Rhythm Block - for songs with tempo or rhythm #}
@SetSongRhythm
{% set songs_with_settings = [] %}
{% for song in songs %}
{% if song.tempo is not none or (song.rhythm_bank is not none and song.rhythm_number is not none) %}
{% set _ = songs_with_settings.append(song) %}
{% endif %}
{% endfor %}
{% if songs_with_settings|length > 0 %}
{% for song in songs %}
{% if song.tempo is not none or (song.rhythm_bank is not none and song.rhythm_number is not none) %}
  {{ 'if' if loop.first else 'elseif' }} SongNb = {{ loop.index0 }}
{% if song.tempo is not none %}
    NewTempo = {{ song.tempo }}
    Call @StartTempoChange
{% endif %}
{% if song.rhythm_bank is not none and song.rhythm_number is not none %}
    SendMIDICC RhythmSetChannel - 1, RhythmBankCC, {{ song.rhythm_bank }}
    SendMIDICC RhythmSetChannel - 1, RhythmCC, {{ song.rhythm_number }}, RhythmSetDelay
{% endif %}
{% endif %}
{% endfor %}
  endif
{% endif %}
@End

@ClearPads
  for i = 0 to 15
    LabelPad i, { }
  endfor
@End

@StopChordNotes
  // Send note-off for all currently active notes on primary channel
  if NumActiveNotes > 0
    for i = 0 to NumActiveNotes - 1
      if ActiveNotes[i] >= 0
        SendMIDINoteOff ChordNoteChannel - 1, ActiveNotes[i], 0
      endif
    endfor
    NumActiveNotes = 0
  endif
  // Send note-off for all currently active notes on simplified channel
  if NumActiveSimplifiedNotes > 0
    for i = 0 to NumActiveSimplifiedNotes - 1
      if ActiveSimplifiedNotes[i] >= 0
        SendMIDINoteOff SimplifiedChordChannel - 1, ActiveSimplifiedNotes[i], 0
      endif
    endfor
    NumActiveSimplifiedNotes = 0
  endif
@End

@StopAllNotes
  // Send note-off for all notes in range (C2 to C5 by default) on both channels
  for note = StopAllNotesMin to StopAllNotesMax
    SendMIDINoteOff ChordNoteChannel - 1, note, 0
    SendMIDINoteOff SimplifiedChordChannel - 1, note, 0
  endfor
@End

{# Macro to play chord notes on both channels #}
{% macro play_chord_notes(chord_info) %}
      // {{ chord_info.chord_symbol }}: {{ chord_info.note_names|join(', ') }} / Simplified: {{ chord_info.simplified_note_names|join(', ') }}
      Call @StopChordNotes
{% if chord_info.midi_notes|length > 0 %}
{% for note in chord_info.midi_notes %}
      SendMIDINoteOn ChordNoteChannel - 1, {{ note }}, ChordNoteVelocity
      ActiveNotes[{{ loop.index0 }}] = {{ note }}
{% endfor %}
      NumActiveNotes = {{ chord_info.midi_notes|length }}
{% else %}
      // No notes for this chord (parsing failed)
      NumActiveNotes = 0
{% endif %}
{% if chord_info.simplified_midi_notes|length > 0 %}
{% for note in chord_info.simplified_midi_notes %}
      SendMIDINoteOn SimplifiedChordChannel - 1, {{ note }}, ChordNoteVelocity
      ActiveSimplifiedNotes[{{ loop.index0 }}] = {{ note }}
{% endfor %}
      NumActiveSimplifiedNotes = {{ chord_info.simplified_midi_notes|length }}
{% else %}
      NumActiveSimplifiedNotes = 0
{% endif %}
{% endmacro %}

{# Chord Playback Blocks - one per song #}
{% for song in songs %}
@PlayChordSong{{ song.song_index }}
  // Play notes for current bar and beat
{% for bar_info in song.chord_structure %}
{% set num_chords = bar_info.num_chords %}
  {{ 'if' if loop.first else 'elseif' }} bar = {{ bar_info.bar_index }}
{% if num_chords == 1 %}
    if beat = 0
{{ play_chord_notes(bar_info.chords[0]) }}
    endif
{% elif num_chords == 2 %}
    if beat = 0
{{ play_chord_notes(bar_info.chords[0]) }}
    elseif beat = 2
{{ play_chord_notes(bar_info.chords[1]) }}
    endif
{% elif num_chords == 3 %}
    if beat = 0
{{ play_chord_notes(bar_info.chords[0]) }}
    elseif beat = 1
{{ play_chord_notes(bar_info.chords[1]) }}
    elseif beat = 3
{{ play_chord_notes(bar_info.chords[2]) }}
    endif
{% elif num_chords == 4 %}
    if beat = 0
{{ play_chord_notes(bar_info.chords[0]) }}
    elseif beat = 1
{{ play_chord_notes(bar_info.chords[1]) }}
    elseif beat = 2
{{ play_chord_notes(bar_info.chords[2]) }}
    elseif beat = 3
{{ play_chord_notes(bar_info.chords[3]) }}
    endif
{% else %}
{# More than 4 chords - use calculated beat positions #}
{% for chord_info in bar_info.chords %}
{% set beat_pos = (chord_info.chord_index * 4.0 / num_chords) | round(0, 'floor') | int %}
    {{ 'if' if loop.first else 'elseif' }} beat = {{ beat_pos }}
{{ play_chord_notes(chord_info) }}
{% endfor %}
    endif
{% endif %}
{% endfor %}
  endif
@End

{% endfor %}

@Bar2PadColor
  section = RoundDown bar/8
  offset = 4
  baseColor = offset + section
  if baseColor > 7
    baseColor = baseColor - 7
  endif
  nextColor = baseColor + 1
  if nextColor > 7
    nextColor = nextColor - 7
  endif

  for pad = 8 to 15
    barInSection = bar - section*8
    if pad - 8 > barInSection
      ColorPad pad, baseColor
    else
      ColorPad pad, nextColor
    endif
  endfor
@End

{# Update Blocks - one per song #}
{% for song in songs %}
{{ song.update_block }}

{% endfor %}

{# OnNewBar - song selection logic #}
@OnNewBar
  bar = HostBar % NbOfBars
  LabelKnob 0, {Bar }, bar + 1
  SetKnobValue 0, 127*bar/(NbOfBars - 1)
  Call @ClearPads
{% for song in songs %}
  {{ 'if' if loop.first else 'elseif' }} SongNb = {{ loop.index0 }}
    Call @UpdateChordsSong{{ loop.index0 }}
{% endfor %}
  endif

  Call @Bar2PadColor
@End

@OnNewBeat
  ColorPad prevPad, 0
  bar = HostBar % NbOfBars
  beat = HostBeat

  pad = beat*2
  if beat = 0
    ColorPad pad, 1
    FlashPad pad
  else
    ColorPad pad, 3
  endif

  prevPad = pad

  // Play chord notes if bar or beat changed
  if bar <> PrevBar or beat <> PrevBeat
{% for song in songs %}
    {{ 'if' if loop.first else 'elseif' }} SongNb = {{ song.song_index }}
      Call @PlayChordSong{{ song.song_index }}
{% endfor %}
    endif

    PrevBar = bar
    PrevBeat = beat
  endif

  // Check for fill triggers
  pos = bar*8 + beat*2
{% set has_fills = songs|selectattr('fill_positions')|list|length > 0 %}
{% if has_fills %}
{% for song in songs %}
{% if song.fill_positions %}
  {{ 'if' if loop.first else 'elseif' }} SongNb = {{ song.song_index }}
{% for fill_pos in song.fill_positions %}
    {{ 'if' if loop.first else 'elseif' }} pos = {{ '%g' % fill_pos if fill_pos != fill_pos|int else fill_pos|int }}
      SendMIDICC FillChannel - 1, FillControl, FillValue, FillDelay
{% endfor %}
    endif
{% endif %}
{% endfor %}
  endif
{% endif %}
@End
